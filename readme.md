## Сервис получения курсов криптовалют с бирж  

### Для запуска:  
1) sh create_envs.sh - создать файлы с переменными окружения для каждого сервиса
2) docker-compose up --build

Полный запуск всех сервисов может занимать 30 сек - мин тк брокер RabbitMQ стартует достаточно долго

### Описание приложения
Приложение состоит из 3х микросервисов:
1) api - FastAPI приложение + postgres, alembic, sqlalchemy. Предоставляет апи для получения данных о курсах криптовалют
2) producer - сервис, создающий задачи для получения курсов криптовалю парсерам binance и coingecko
3) consumer - сервис, парсящий курсы валют с coingecko и binance(в одном сервисе 2 консьюмера, по одному на биржу)


### Принцип работы
1. Каждые N секунд(по дефолту 4) producer создает задачи на парсинг всех нужных курсов криптовалют   
и отсылает сообщения в соответствующие очереди RabbitMQ для каждой биржи(очереди **binance_parser** и **coingeko_parser**)
2. Парсеры после получения сообщения получают курсы криптовалют через RestAPI(для coingecko) и через websocket(для Binance)
3. После получения ответа от криптобирж они записывают курсы в json-подобную структуру в redis'e + добавляют  
timestamp последнего времени обновления
4. При запросе к апи приложение проверяет наличие данных по курсу в редисе и их валидность с учетом времени жизни кеша

----
### Описание compose сервисов
1. app - FastAPI приложение
2. nginx - веб сервер
3. db - база postgres
4. redis - кеш, хранящий спаршенные курсы валют
5. rabbitmq - брокер сообщений, в который передаются задачи парсерам на получение курсов валют
6. producer - сервис, который создает задачи на парсинг курсов валют
7. binance_consumer - парсер курсов криптовалют с binance  
запущено 4 реплики тк апи binance долго отвечает, но не имеет строго ограничения на количество запросов в сек
8. coingeko_consumer - парсер курсов криптовалют с coingecko,  
запущена 1 реплика тк строгий лимит на количество запросов к бирже(30 в мин)

При наличии тарифных планов coingecko/binance можно увеличить количество реплик для еще более точных курсов  
криптовалют
---
Не смог провести полноценное нагрузочное тестирование с помощью locust тк при запуске всех сервисов  
ресурсы цп не позволяли проводить тесты на 100+ rps  
CPU usage above 90%! This may constrain your throughput and may even give inconsistent response time measurements!